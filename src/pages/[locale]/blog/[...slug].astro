---
import {getCollection, render} from 'astro:content';
import Base from '@/layouts/Base.astro';
import {locales} from '@/i18n';
import CommentSection from '@/components/CommentSection';

export async function getStaticPaths() {
  const pages = await getCollection('blog');

  return pages.map(page => {
    // 从文件路径中提取语言和slug
    const [locale, ...slugParts] = page.id.split('/');
    const slug = slugParts.join('/') || undefined;

    // 基于translation_id 查找同一文章的其他语言版本
    const translations: { [key: string]: string } = {};
    if (page.data.translation_id) {
      Object.keys(locales).forEach(loc => {
        translations[loc] = `/blog/${page.data.translation_id}`;
      });
    }

    return {
      params: {locale, slug},
      props: {page, translations}
    };
  });
}

const {locale} = Astro.params;
const {page} = Astro.props;
const formattedDate = page.data.created_at.toLocaleString(locale);
const {Content} = await render(page);
---

<Base>
    <article class="blog-post">
        <header class="post-header">
            <div class="post-meta">
                <time datetime={page.data.created_at.toISOString()}>
                  {formattedDate}
                </time>
                <span class="reading-time">~{page.data.estimated} min</span>
              {page.data.tags && (
                  <div class="tags">
                    {page.data.tags.map((tag) => (
                        <a href={`/${locale}/blog/tag/${tag}`} class="tag">#{tag}</a>
                    ))}
                  </div>
              )}
            </div>
            <h1 class="post-title">{page.data.title}</h1>
            <div class="post-description">
                <p>Omnis doloribus aut omnis tempore. Nostrum et non et earum. Et ipsum dolores reprehenderit eveniet
                    aspernatur officia quam et. Omnis doloribus aut omnis tempore. Nostrum et non et earum. Et ipsum
                    dolores reprehenderit eveniet aspernatur officia quam et.</p>
            </div>
        </header>

        <div class="post-content">
            <Content/>
        </div>

        <footer class="post-footer">
            <div class="license">
                <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener">
                    BY-NC-SA
                </a>
            </div>
        </footer>

        <hr class="comment-divider"/>

        <!-- 使用动态评论组件替换静态评论区 -->
        <CommentSection client:load postId={page.data.translation_id || page.id} locale={locale}/>
    </article>
</Base>

<style>
    /* 博客文章整体样式 */
    .blog-post {
        max-width: 800px;
        margin: 0 auto;
        padding: 2rem 1rem;
    }

    /* 文章头部样式 */
    .post-header {
        margin-bottom: 2rem;
    }

    .post-meta {
        display: flex;
        gap: 1rem;
        font-size: 0.9rem;
        margin-bottom: 1rem;
        color: #666;
    }

    .post-title {
        font-size: 3rem;
        line-height: 1.2;
        margin: 1.5rem 0;
        font-weight: 900;
    }

    .post-description {
        font-size: 1.2rem;
        line-height: 1.6;
        margin-bottom: 2rem;
    }

    /* 文章内容样式 */
    .post-content {
        line-height: 1.6;
        font-size: 1.1rem;
        margin-bottom: 3rem;
    }

    .post-content h2 {
        font-size: 1.8rem;
        margin: 2rem 0 1rem;
    }

    .post-content p {
        margin-bottom: 1.5rem;
    }

    .post-content pre {
        background-color: #f8f8f8;
        border-radius: 4px;
        padding: 1rem;
        margin: 1.5rem 0;
        overflow-x: auto;
    }

    /* 文章底部样式 */
    .post-footer {
        margin-top: 3rem;
        padding-top: 1rem;
        display: flex;
        justify-content: center;
    }

    .license {
        display: inline-block;
        font-size: 0.9rem;
    }

    .license a {
        text-decoration: none;
        color: #333;
    }

    /* 评论区分隔线 */
    .comment-divider {
        border: none;
        border-top: 1px solid #eee;
        margin: 3rem 0;
    }

    /* 标签样式 */
    .tag {
        display: inline-block;
        margin-right: 0.5rem;
        text-decoration: none;
        color: #666;
    }

    /* 响应式设计 */
    @media (max-width: 768px) {
        .post-title {
            font-size: 2rem;
        }

        .post-description {
            font-size: 1rem;
        }
    }
</style>
